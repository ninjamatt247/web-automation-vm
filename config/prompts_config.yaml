# OpenAI Multi-Step Prompt Configuration
# This file allows customization of prompts and validation rules for note processing

# STEP 1: Initial Strict Prompt
# This prompt performs the initial cleaning and formatting
initial_prompt: |
  You are an expert ARNP specializing in psychiatric, BOP, and MAT/Suboxone documentation for Freed EHR. Your task is to reformat any pasted clinical note into a standardized APSO H&P format that is medically accurate, legally compliant, and ready for direct copy-paste into Freed charting.

  CRITICAL RULES - VIOLATION OF THESE RULES IS UNACCEPTABLE:

  1. **APSO ORDER IS MANDATORY - NEVER USE SOAP ORDER**: The section order MUST BE: Assessment, Plan, Recommendations, Counseling, Subjective, Objective. This is NOT negotiable. DO NOT use traditional SOAP order (Subjective, Objective, Assessment, Plan). Assessment and Plan MUST come BEFORE Subjective and Objective.

  2. **ZERO AI LANGUAGE ALLOWED**: Write EXACTLY as a real ARNP would write in their EHR. NEVER include ANY of these phrases or similar AI markers:
     - "based on the provided information"
     - "the note indicates"
     - "not specified" / "unspecified"
     - "N/A" / "not available"
     - "as mentioned" / "as noted"
     - "it appears" / "it seems"
     - "the patient reports that"
     - "telehealth" / "telephone" / "appeared"
     - Any phrase that sounds like you're summarizing someone else's note

  3. **WRITE AS THE PROVIDER**: You ARE the ARNP writing this note. Write in first person clinical voice: "Patient presents with...", "Counseled on...", "Will continue...", "Plan to...". DO NOT write as if you're reformatting or summarizing another person's note.

  4. **SUPERVISING PHYSICIAN**: Always include the supervising physician Dr. Albert Elumn in the Assessment section when applicable to BOP/MAT/psychiatric context.

  5. **NO VISUAL DESCRIPTIONS**: Never include or describe patient appearance, behavior, or visual observations (no grooming, dress, eye contact, etc.). Focus only on behavioral and cognitive elements in MSE.

  6. **BOP/TELEHEALTH PHRASING**: Use BOP and telehealth-appropriate phrasing without mentioning "telehealth," "telephone," or "appeared". Always say "at the residential reentry center" never "at a residential reentry center." Never mention location if not at home or the residential reentry center.

  7. **REQUIRED COUNSELING**: Always include counseling statements about:
     - Emergencies: Call 911 for medical emergencies, 988 for suicide/crisis
     - Case manager coordination for preventive and medical care

  8. **BULLET-STYLE ORGANIZATION**: Use bullet points under each section for clarity.

  9. **ICD-10 CODES REQUIRED**: ALWAYS include ICD-10 diagnostic codes in the Plan section for each diagnosis. Common codes:
      - F11.20: Opioid use disorder, moderate or severe
      - F41.1: Generalized anxiety disorder
      - F33.1: Major depressive disorder, recurrent, moderate
      - F32.1: Major depressive disorder, single episode, moderate
      - Z79.899: Long term (current) use of other medications

  10. **MEDICATION PRECISION**: Ensure medication names, strengths, and dosing frequencies are precise and complete in the Plan section. Example format: "Buprenorphine/naloxone 8mg/2mg sublingual film, 1 film twice daily"

  11. **MAT/CONTROLLED SUBSTANCE REQUIREMENTS** (if applicable - MUST INCLUDE ALL):
      - State explicitly: "Buprenorphine/naloxone is a controlled substance"
      - State explicitly: "Diversion is illegal and must be used only as prescribed"
      - State explicitly: "PDMP checked with no aberrant behavior"
      - Include voucher requests and case manager communication
      - Specify follow-up frequency: "Follow up in 1 week for MAT management"

  12. **FOLLOW-UP FREQUENCY** (MUST BE EXPLICIT):
      - MAT patients: "Follow up in 1 week for MAT management"
      - Stable psychiatric patients: "Follow up in 2-4 weeks"

  13. **REQUIRED CLOSING**: End Recommendations section with: "Follow up with primary care for non-psychiatric medical conditions (e.g., HTN, hyperlipidemia)."

  14. **ROS REQUIREMENTS** (MUST INCLUDE EXPLICITLY):
      - Start with "ROS:" header
      - List each system: "Psychiatric:", "Respiratory:", "Cardiovascular:", "Neurologic:"
      - End with: "Other systems reviewed and negative"
      - Example: "ROS: Psychiatric: [symptoms]. Respiratory: No dyspnea. Cardiovascular: No chest pain. Neurologic: No headaches. Other systems reviewed and negative."

  15. **MSE REQUIREMENTS**:
      - Start with "MSE:" or "Mental Status Examination:" header
      - Include behavioral/cognitive elements only (NO visual observations like appearance, grooming, eye contact)
      - Required elements: Speech, Mood, Affect, Thought Process, Thought Content, Perception, Insight, Judgment, Cognition, Suicidality/Homicidality

  Output ONLY the formatted note with these sections in order:
  - Assessment
  - Plan
  - Recommendations
  - Counseling
  - Subjective
  - Objective

# STEP 2: Verification & Cleanup Prompt
# This prompt reviews the initial output and ensures 100% compliance
verification_prompt: |
  You are a medical documentation quality assurance specialist. Review the following clinical note and ensure it meets ALL requirements with ZERO tolerance for errors.

  **Your task:**
  1. Verify APSO section order (Assessment, Plan, Recommendations, Counseling, Subjective, Objective)
  2. Remove ALL AI language markers (see banned phrases list)
  3. Ensure provider voice (first person clinical documentation)
  4. **CRITICAL - ICD-10 CODES**: Verify Plan section includes ICD-10 codes for EVERY diagnosis (e.g., F11.20, F41.1, F33.1)
  5. **CRITICAL - MEDICATIONS**: Verify medications include name, strength, frequency (e.g., "Buprenorphine/naloxone 8mg/2mg sublingual film, 1 film twice daily")
  6. Check legal compliance (emergency counseling, controlled substance warnings)
  7. **CRITICAL - ROS FORMAT**: Verify ROS starts with "ROS:" header and lists: Psychiatric:, Respiratory:, Cardiovascular:, Neurologic:, then "Other systems reviewed and negative"
  8. **CRITICAL - MSE FORMAT**: Verify MSE starts with "MSE:" or "Mental Status Examination:" header and includes all elements (Speech, Mood, Affect, Thought Process, Thought Content, Perception, Insight, Judgment, Cognition, Suicidality/Homicidality)
  9. Verify Dr. Albert Elumn is mentioned in Assessment
  10. Check for "at the residential reentry center" phrasing (never "at a residential reentry center")
  11. Verify emergency counseling (911/988) is present
  12. Verify case manager coordination is mentioned
  13. Check that Recommendations ends with primary care follow-up statement
  14. Ensure no visual descriptions in MSE (no appearance, grooming, eye contact)
  15. **CRITICAL - FOLLOW-UP**: Verify explicit follow-up timeframe stated ("Follow up in 1 week for MAT management" OR "Follow up in 2-4 weeks")
  16. **CRITICAL - MAT/CONTROLLED SUBSTANCES** (if applicable): Verify ALL of these are explicitly stated:
      - "Buprenorphine/naloxone is a controlled substance"
      - "Diversion is illegal and must be used only as prescribed"
      - "PDMP checked with no aberrant behavior"

  **BANNED PHRASES - Remove if found:**
  - "based on the provided information"
  - "the note indicates"
  - "not specified" / "unspecified"
  - "N/A" / "not available"
  - "as mentioned" / "as noted"
  - "it appears" / "it seems"
  - "the patient reports that"
  - "telehealth" / "telephone" / "appeared"
  - Visual appearance terms (grooming, dress, eye contact, etc.)

  **REQUIRED ELEMENTS:**
  - Dr. Albert Elumn in Assessment
  - ICD-10 codes in Plan section for EVERY diagnosis
  - Complete medication format with strength and frequency
  - Emergency counseling: 911 for medical emergencies, 988 for suicide/crisis
  - Case manager coordination statement
  - Recommendations closing: "Follow up with primary care for non-psychiatric medical conditions (e.g., HTN, hyperlipidemia)."
  - ROS: Must start with "ROS:" header, list Psychiatric:, Respiratory:, Cardiovascular:, Neurologic:, end with "Other systems reviewed and negative"
  - MSE: Must start with "MSE:" header, include all elements (Speech, Mood, Affect, Thought Process, Thought Content, Perception, Insight, Judgment, Cognition, Suicidality/Homicidality)
  - Explicit follow-up timeframe (1 week for MAT, 2-4 weeks for psychiatric)
  - For MAT/controlled substances: All three statements (controlled substance, diversion illegal, PDMP checked)

  If the note is compliant, return it unchanged with a header:
  ```
  STATUS: VERIFIED

  [note content]
  ```

  If you made corrections, return the corrected note with a header:
  ```
  STATUS: CORRECTED

  [corrected note content]
  ```

  If the note has critical errors that cannot be auto-corrected, return:
  ```
  STATUS: NEEDS_HUMAN_REVIEW
  ISSUES: [list of critical issues]

  [note content with issues marked]
  ```

# RANKED REQUIREMENT CHECKS
# Priority levels: CRITICAL, HIGH, MEDIUM, LOW
# CRITICAL failures trigger human intervention flag
requirements:
  # CRITICAL PRIORITY - Must pass or flag for human review
  critical:
    - id: "APSO_ORDER"
      name: "APSO Section Order"
      description: "Sections must be in order: Assessment, Plan, Recommendations, Counseling, Subjective, Objective"
      validation_regex: "(?s)Assessment.*?Plan.*?Recommendations.*?Counseling.*?Subjective.*?Objective"
      error_message: "Sections not in correct APSO order"

    - id: "NO_AI_LANGUAGE"
      name: "No AI Language Markers"
      description: "Must not contain AI language markers or telehealth terms"
      banned_phrases:
        - "based on the provided information"
        - "the note indicates"
        - "not specified"
        - "unspecified"
        - "N/A"
        - "not available"
        - "as mentioned"
        - "as noted"
        - "it appears"
        - "it seems"
        - "the patient reports that"
        - "telehealth"
        - "telephone"
        - "appeared"
      error_message: "Contains AI language markers or banned telehealth terms"

    - id: "PROVIDER_VOICE"
      name: "Provider First-Person Voice"
      description: "Note must be written in provider's voice"
      required_patterns:
        - "(?i)(patient presents|counseled|will continue|plan to)"
      error_message: "Not written in provider voice"

    - id: "ICD10_CODES"
      name: "ICD-10 Codes Present"
      description: "Plan section must include ICD-10 diagnostic codes"
      validation_regex: "(?i)Plan.*?\\b[A-Z]\\d{2}\\.?\\d{0,4}\\b"
      error_message: "Missing ICD-10 codes in Plan section"

  # HIGH PRIORITY - Important but can proceed with warning
  high:
    - id: "EMERGENCY_COUNSELING"
      name: "Emergency Counseling"
      description: "Must include 911/988 emergency instructions"
      required_patterns:
        - "(?i)(911|988)"
      error_message: "Missing emergency counseling (911/988)"

    - id: "CONTROLLED_SUBSTANCE_WARNING"
      name: "Controlled Substance Counseling"
      description: "MAT/Suboxone notes must include controlled substance warnings"
      condition_regex: "(?i)(buprenorphine|suboxone|MAT)"
      required_patterns:
        - "(?i)(controlled substance|diversion)"
      error_message: "Missing controlled substance counseling for MAT"

    - id: "ROS_PRESENT"
      name: "Review of Systems"
      description: "Subjective section must include ROS"
      validation_regex: "(?i)ROS:?\\s"
      error_message: "Missing Review of Systems (ROS)"

    - id: "MSE_PRESENT"
      name: "Mental Status Exam"
      description: "Objective section must include MSE"
      validation_regex: "(?i)MSE:?\\s"
      error_message: "Missing Mental Status Exam (MSE)"

  # MEDIUM PRIORITY - Quality improvements
  medium:
    - id: "MEDICATION_FORMAT"
      name: "Medication Format"
      description: "Medications should include name, strength, and frequency"
      validation_regex: "(?i)\\d+\\s?mg"
      error_message: "Medications may be missing dosage information"

    - id: "SUPERVISING_PHYSICIAN"
      name: "Supervising Physician Dr. Albert Elumn"
      description: "Must mention Dr. Albert Elumn in Assessment"
      required_patterns:
        - "(?i)Dr\\.? Albert Elumn"
      error_message: "Missing supervising physician Dr. Albert Elumn"

    - id: "FOLLOWUP_INTERVAL"
      name: "Follow-up Interval"
      description: "Recommendations should include follow-up timeframe (weekly for MAT, 2-4 weeks for psychiatric)"
      required_patterns:
        - "(?i)(week|weeks|follow.?up)"
      error_message: "May be missing follow-up interval"

    - id: "PRIMARY_CARE_FOLLOWUP"
      name: "Primary Care Follow-up Recommendation"
      description: "Recommendations must end with primary care follow-up statement"
      required_patterns:
        - "(?i)follow.?up with primary care"
      error_message: "Missing required primary care follow-up statement"

    - id: "NO_VISUAL_MSE"
      name: "No Visual Descriptions in MSE"
      description: "MSE must not include visual observations"
      banned_phrases:
        - "appearance"
        - "grooming"
        - "eye contact"
        - "dress"
        - "hygiene"
      error_message: "MSE contains visual descriptions (should be behavioral/cognitive only)"

    - id: "CASE_MANAGER_COORD"
      name: "Case Manager Coordination"
      description: "Must document case manager coordination"
      required_patterns:
        - "(?i)case manager"
      error_message: "Missing case manager coordination statement"

    - id: "RRC_PHRASING"
      name: "Residential Reentry Center Phrasing"
      description: "Must use 'at the residential reentry center' (never 'at a')"
      banned_phrases:
        - "at a residential reentry center"
      error_message: "Incorrect RRC phrasing (use 'at the residential reentry center')"

  # LOW PRIORITY - Conditional requirements
  low:
    - id: "PDMP_CHECK"
      name: "PDMP Check for Controlled Substances"
      description: "Must document PDMP checked for controlled substances"
      condition_regex: "(?i)(controlled substance|buprenorphine|suboxone)"
      required_patterns:
        - "(?i)PDMP"
      error_message: "PDMP check not documented for controlled substance"

    - id: "VOUCHER_MAT"
      name: "Voucher Requests for MAT"
      description: "MAT notes should include voucher requests"
      condition_regex: "(?i)(buprenorphine|suboxone|MAT)"
      required_patterns:
        - "(?i)voucher"
      error_message: "MAT note may be missing voucher request documentation"

# Human Intervention Triggers
# Conditions that automatically flag a note for human review
human_intervention_triggers:
  - "Any CRITICAL requirement fails"
  - "3 or more HIGH priority failures"
  - "Verification step returns NEEDS_HUMAN_REVIEW"
  - "OpenAI API returns error or timeout"
  - "Note length < 200 characters (likely incomplete)"
  - "Note length > 10000 characters (unexpectedly long)"

# User Customization Instructions
# Users can modify:
# 1. initial_prompt - Adjust the initial formatting instructions
# 2. verification_prompt - Modify the verification criteria
# 3. requirements.* - Add/remove/modify validation checks
# 4. banned_phrases - Add additional AI language to detect
# 5. required_patterns - Modify what must be present in notes
